"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.dasmTypeScript = void 0;
const codemaker_1 = require("codemaker");
const fs = require("fs");
const os = require("os");
const path = require("path");
const util_1 = require("util");
const mkdtemp = util_1.promisify(fs.mkdtemp);
const readFile = util_1.promisify(fs.readFile);
async function dasmTypeScript(template, options = {}) {
    const definitions = new Array();
    for (const [id, resource] of Object.entries(template.Resources || {})) {
        const type = resource.Type;
        const props = resource.Properties || {};
        definitions.push({
            id,
            ...toCfnClassName(type),
            props: capitalizeKeys(props)
        });
    }
    const code = new codemaker_1.CodeMaker();
    const outFile = 'out.ts';
    code.openFile(outFile);
    const timestamp = options.timestamp !== undefined ? options.timestamp : true;
    const suffix = timestamp ? `at ${new Date().toISOString()}` : '';
    code.line(`// generated by cdk-dasm ${suffix}`);
    code.line();
    //
    // imports
    //
    code.line(`import { Stack, StackProps, Fn } from 'aws-cdk-lib';`);
    code.line(`import { Construct } from 'constructs';`);
    for (const ns of getUniqueNamespaces(definitions)) {
        const importName = `aws-cdk-lib/aws_${ns}`;
        code.line(`import ${ns} from '${importName}';`);
    }
    code.line();
    //
    // stack
    //
    code.openBlock(`export class MyStack extends Stack`);
    code.openBlock(`constructor(scope: Construct, id: string, props: StackProps = {})`);
    code.line(`super(scope, id, props);`);
    for (const def of definitions) {
        // no props
        if (Object.keys(def.props).length === 0) {
            code.line(`new ${def.className}(this, '${def.id}');`);
            continue;
        }
        code.indent(`new ${def.className}(this, '${def.id}', {`);
        for (const [key, value] of Object.entries(def.props)) {
            const json = JSON.stringify(value, undefined, 2);
            const [first, ...rest] = json.split('\n');
            if (rest.length === 0) {
                code.line(`${key}: ${first},`); // single line
            }
            else {
                code.line(`${key}: ${first}`);
                rest.forEach((r, i) => {
                    code.line(r + ((i === rest.length - 1) ? ',' : ''));
                });
            }
        }
        code.unindent('});');
    }
    code.closeBlock();
    code.closeBlock(' // MyStack');
    code.closeFile(outFile);
    const workdir = await mkdtemp(path.join(os.tmpdir(), 'cdk-dasm-typescript'));
    await code.save(workdir);
    return (await readFile(path.join(workdir, outFile))).toString();
}
exports.dasmTypeScript = dasmTypeScript;
function capitalizeKeys(x) {
    if (typeof (x) === 'function') {
        throw new Error(`function?`);
    }
    if (Array.isArray(x)) {
        return x.map(i => capitalizeKeys(i));
    }
    if (typeof (x) === 'object') {
        const ret = {};
        for (const [key, value] of Object.entries(x)) {
            let newKey;
            if (key === 'Ref' || key.startsWith('Fn::')) {
                newKey = key;
            }
            else {
                newKey = codemaker_1.toCamelCase(key);
            }
            ret[newKey] = capitalizeKeys(value);
        }
        return ret;
    }
    // primitive
    return x;
}
function toCfnClassName(resourceType) {
    const [, namespace, type] = resourceType.split('::');
    const className = `${(namespace === 'Serverless' ? 'Sam' : namespace).toLocaleLowerCase()}.Cfn${type}`;
    return { namespace: namespace.toLocaleLowerCase(), className };
}
function getUniqueNamespaces(definitions) {
    return [...new Set(definitions.map(definition => definition.namespace))].map((ns) => ns === 'serverless' ? 'sam' : ns);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRhc20udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEseUNBQW1EO0FBQ25ELHlCQUF5QjtBQUN6Qix5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLCtCQUFpQztBQUVqQyxNQUFNLE9BQU8sR0FBRyxnQkFBUyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN0QyxNQUFNLFFBQVEsR0FBRyxnQkFBUyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQWtCakMsS0FBSyxVQUFVLGNBQWMsQ0FBQyxRQUFrQixFQUFFLFVBQStCLEVBQUU7SUFDeEYsTUFBTSxXQUFXLEdBQUcsSUFBSSxLQUFLLEVBQXVCLENBQUM7SUFFckQsS0FBSyxNQUFNLENBQUUsRUFBRSxFQUFFLFFBQVEsQ0FBRSxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFNBQVMsSUFBSSxFQUFFLENBQUMsRUFBRTtRQUN2RSxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQzNCLE1BQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxVQUFVLElBQUksRUFBRSxDQUFDO1FBRXhDLFdBQVcsQ0FBQyxJQUFJLENBQUM7WUFDZixFQUFFO1lBQ0YsR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDO1lBQ3ZCLEtBQUssRUFBRSxjQUFjLENBQUMsS0FBSyxDQUFDO1NBQzdCLENBQUMsQ0FBQztLQUNKO0lBRUQsTUFBTSxJQUFJLEdBQUcsSUFBSSxxQkFBUyxFQUFFLENBQUM7SUFFN0IsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDO0lBRXpCLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFdkIsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLFNBQVMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUM3RSxN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LENBQUM7S0FDWjtJQUVELFlBQVk7SUFDWixPQUFPLENBQUMsQ0FBQztBQUNYLENBQUM7QUFFRCxTQUFTLGNBQWMsQ0FBQyxZQUFvQjtJQUMxQyxNQUFNLENBQUUsQUFBRCxFQUFHLFNBQVMsRUFBRSxJQUFJLENBQUUsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZELE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxTQUFTLEtBQUssWUFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLGlCQUFpQixFQUFFLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFDdkcsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxTQUFTLEVBQUUsQ0FBQztBQUNqRSxDQUFDO0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxXQUF1QztJQUNsRSxPQUFPLENBQUMsR0FBSSxJQUFJLEdBQUcsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsS0FBSyxZQUFZLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDMUgsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvZGVNYWtlciwgdG9DYW1lbENhc2UgfSBmcm9tICdjb2RlbWFrZXInO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0ICogYXMgb3MgZnJvbSAnb3MnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHByb21pc2lmeSB9IGZyb20gJ3V0aWwnO1xuXG5jb25zdCBta2R0ZW1wID0gcHJvbWlzaWZ5KGZzLm1rZHRlbXApO1xuY29uc3QgcmVhZEZpbGUgPSBwcm9taXNpZnkoZnMucmVhZEZpbGUpO1xuXG5pbnRlcmZhY2UgQ29uc3RydWN0RGVmaW5pdGlvbiB7XG4gIG5hbWVzcGFjZTogc3RyaW5nO1xuICBjbGFzc05hbWU6IHN0cmluZztcbiAgaWQ6IHN0cmluZztcbiAgcHJvcHM6IHsgW2tleTogc3RyaW5nXTogYW55IH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGlzYXNzZW1ibGVyT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBJbmNsdWRlIGEgdGltZXN0YW1wIGluIHRoZSBnZW5lcmF0ZWQgb3V0cHV0LlxuICAgKlxuICAgKiBAZGVmYXVsdCB0cnVlXG4gICAqL1xuICByZWFkb25seSB0aW1lc3RhbXA/OiBib29sZWFuO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGFzbVR5cGVTY3JpcHQodGVtcGxhdGU6IFRlbXBsYXRlLCBvcHRpb25zOiBEaXNhc3NlbWJsZXJPcHRpb25zID0ge30pIHtcbiAgY29uc3QgZGVmaW5pdGlvbnMgPSBuZXcgQXJyYXk8Q29uc3RydWN0RGVmaW5pdGlvbj4oKTtcblxuICBmb3IgKGNvbnN0IFsgaWQsIHJlc291cmNlIF0gb2YgT2JqZWN0LmVudHJpZXModGVtcGxhdGUuUmVzb3VyY2VzIHx8IHt9KSkge1xuICAgIGNvbnN0IHR5cGUgPSByZXNvdXJjZS5UeXBlO1xuICAgIGNvbnN0IHByb3BzID0gcmVzb3VyY2UuUHJvcGVydGllcyB8fCB7fTtcblxuICAgIGRlZmluaXRpb25zLnB1c2goe1xuICAgICAgaWQsXG4gICAgICAuLi50b0NmbkNsYXNzTmFtZSh0eXBlKSxcbiAgICAgIHByb3BzOiBjYXBpdGFsaXplS2V5cyhwcm9wcylcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IGNvZGUgPSBuZXcgQ29kZU1ha2VyKCk7XG5cbiAgY29uc3Qgb3V0RmlsZSA9ICdvdXQudHMnO1xuXG4gIGNvZGUub3BlbkZpbGUob3V0RmlsZSk7XG5cbiAgY29uc3QgdGltZXN0YW1wID0gb3B0aW9ucy50aW1lc3RhbXAgIT09IHVuZGVmaW5lZCA/IG9wdGlvbnMudGltZXN0YW1wIDogdHJ1ZTtcbiAgY29uc3Qgc3VmZml4ID0gdGltZXN0YW1wID8gIGBhdCAke25ldyBEYXRlKCkudG9JU09TdHJpbmcoKX1gIDogJyc7XG5cbiAgY29kZS5saW5lKGAvLyBnZW5lcmF0ZWQgYnkgY2RrLWRhc20gJHtzdWZmaXh9YCk7XG4gIGNvZGUubGluZSgpO1xuXG4gIC8vXG4gIC8vIGltcG9ydHNcbiAgLy9cblxuICBjb2RlLmxpbmUoYGltcG9ydCB7IFN0YWNrLCBTdGFja1Byb3BzLCBGbiB9IGZyb20gJ2F3cy1jZGstbGliJztgKTtcbiAgY29kZS5saW5lKGBpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztgKTtcblxuICBmb3IgKGNvbnN0IG5zIG9mIGdldFVuaXF1ZU5hbWVzcGFjZXMoZGVmaW5pdGlvbnMpKSB7XG4gICAgY29uc3QgaW1wb3J0TmFtZSA9IGBhd3MtY2RrLWxpYi9hd3NfJHtuc31gO1xuICAgIGNvZGUubGluZShgaW1wb3J0ICR7bnN9IGZyb20gJyR7aW1wb3J0TmFtZX0nO2ApO1xuICB9XG5cbiAgY29kZS5saW5lKCk7XG5cbiAgLy9cbiAgLy8gc3RhY2tcbiAgLy9cblxuICBjb2RlLm9wZW5CbG9jayhgZXhwb3J0IGNsYXNzIE15U3RhY2sgZXh0ZW5kcyBTdGFja2ApO1xuICBjb2RlLm9wZW5CbG9jayhgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFN0YWNrUHJvcHMgPSB7fSlgKTtcbiAgY29kZS5saW5lKGBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtgKTtcblxuICBmb3IgKGNvbnN0IGRlZiBvZiBkZWZpbml0aW9ucykge1xuXG4gICAgLy8gbm8gcHJvcHNcbiAgICBpZiAoT2JqZWN0LmtleXMoZGVmLnByb3BzKS5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvZGUubGluZShgbmV3ICR7ZGVmLmNsYXNzTmFtZX0odGhpcywgJyR7ZGVmLmlkfScpO2ApO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgY29kZS5pbmRlbnQoYG5ldyAke2RlZi5jbGFzc05hbWV9KHRoaXMsICcke2RlZi5pZH0nLCB7YCk7XG5cbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhkZWYucHJvcHMpKSB7XG4gICAgICBjb25zdCBqc29uID0gSlNPTi5zdHJpbmdpZnkodmFsdWUsIHVuZGVmaW5lZCwgMik7XG4gICAgICBjb25zdCBbIGZpcnN0LCAuLi5yZXN0IF0gPSBqc29uLnNwbGl0KCdcXG4nKTtcblxuICAgICAgaWYgKHJlc3QubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGNvZGUubGluZShgJHtrZXl9OiAke2ZpcnN0fSxgKTsgLy8gc2luZ2xlIGxpbmVcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvZGUubGluZShgJHtrZXl9OiAke2ZpcnN0fWApO1xuICAgICAgICByZXN0LmZvckVhY2goKHIsIGkpID0+IHtcbiAgICAgICAgICBjb2RlLmxpbmUociArICgoaSA9PT0gcmVzdC5sZW5ndGggLSAxKSA/ICcsJyA6ICcnKSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvZGUudW5pbmRlbnQoJ30pOycpO1xuICB9XG5cbiAgY29kZS5jbG9zZUJsb2NrKCk7XG5cbiAgY29kZS5jbG9zZUJsb2NrKCcgLy8gTXlTdGFjaycpO1xuXG4gIGNvZGUuY2xvc2VGaWxlKG91dEZpbGUpO1xuXG4gIGNvbnN0IHdvcmtkaXIgPSBhd2FpdCBta2R0ZW1wKHBhdGguam9pbihvcy50bXBkaXIoKSwgJ2Nkay1kYXNtLXR5cGVzY3JpcHQnKSk7XG4gIGF3YWl0IGNvZGUuc2F2ZSh3b3JrZGlyKTtcblxuICByZXR1cm4gKGF3YWl0IHJlYWRGaWxlKHBhdGguam9pbih3b3JrZGlyLCBvdXRGaWxlKSkpLnRvU3RyaW5nKCk7XG59XG5cbmZ1bmN0aW9uIGNhcGl0YWxpemVLZXlzKHg6IGFueSk6IGFueSB7XG4gIGlmICh0eXBlb2YoeCkgPT09ICdmdW5jdGlvbicpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYGZ1bmN0aW9uP2ApO1xuICB9XG5cbiAgaWYgKEFycmF5LmlzQXJyYXkoeCkpIHtcbiAgICByZXR1cm4geC5tYXAoaSA9PiBjYXBpdGFsaXplS2V5cyhpKSk7XG4gIH1cblxuICBpZiAodHlwZW9mKHgpID09PSAnb2JqZWN0Jykge1xuICAgIGNvbnN0IHJldDogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9O1xuICAgIGZvciAoY29uc3QgWyBrZXksIHZhbHVlIF0gb2YgT2JqZWN0LmVudHJpZXMoeCkpIHtcbiAgICAgIGxldCBuZXdLZXk7XG4gICAgICBpZiAoa2V5ID09PSAnUmVmJyB8fCBrZXkuc3RhcnRzV2l0aCgnRm46OicpKSB7XG4gICAgICAgIG5ld0tleSA9IGtleTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5ld0tleSA9IHRvQ2FtZWxDYXNlKGtleSk7XG4gICAgICB9XG5cbiAgICAgIHJldFtuZXdLZXldID0gY2FwaXRhbGl6ZUtleXModmFsdWUpO1xuICAgIH1cbiAgICByZXR1cm4gcmV0O1xuICB9XG5cbiAgLy8gcHJpbWl0aXZlXG4gIHJldHVybiB4O1xufVxuXG5mdW5jdGlvbiB0b0NmbkNsYXNzTmFtZShyZXNvdXJjZVR5cGU6IHN0cmluZykge1xuICBjb25zdCBbICwgbmFtZXNwYWNlLCB0eXBlIF0gPSByZXNvdXJjZVR5cGUuc3BsaXQoJzo6Jyk7XG4gIGNvbnN0IGNsYXNzTmFtZSA9IGAkeyhuYW1lc3BhY2UgPT09ICdTZXJ2ZXJsZXNzJyA/ICdTYW0nIDogbmFtZXNwYWNlKS50b0xvY2FsZUxvd2VyQ2FzZSgpfS5DZm4ke3R5cGV9YDtcbiAgcmV0dXJuIHsgbmFtZXNwYWNlOiBuYW1lc3BhY2UudG9Mb2NhbGVMb3dlckNhc2UoKSwgY2xhc3NOYW1lIH07XG59XG5cbmZ1bmN0aW9uIGdldFVuaXF1ZU5hbWVzcGFjZXMoZGVmaW5pdGlvbnM6IEFycmF5PENvbnN0cnVjdERlZmluaXRpb24+KTogU3RyaW5nW10ge1xuICByZXR1cm4gWy4uLiBuZXcgU2V0KGRlZmluaXRpb25zLm1hcChkZWZpbml0aW9uID0+IGRlZmluaXRpb24ubmFtZXNwYWNlKSldLm1hcCgobnMpID0+IG5zID09PSAnc2VydmVybGVzcycgPyAnc2FtJyA6IG5zKTtcbn1cblxuaW50ZXJmYWNlIFRlbXBsYXRlIHtcbiAgUmVzb3VyY2VzOiB7IFtpZDogc3RyaW5nXTogUmVzb3VyY2UgfTtcbn1cblxuaW50ZXJmYWNlIFJlc291cmNlIHtcbiAgVHlwZTogc3RyaW5nO1xuICBQcm9wZXJ0aWVzPzogeyBbcHJvcDogc3RyaW5nXTogYW55IH1cbn1cbiJdfQ==